<!DOCTYPE html>
<html>

<head>
    <title>PCT by SLR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap"
        rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            background: #fff;
            font-family: 'EB Garamond', Georgia, serif;
            color: #1a1a1a;
        }

        /* ────────────────────────────────────
           Story view
           ──────────────────────────────────── */
        #st-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 20px;
            z-index: 30;
            cursor: pointer;
            background: transparent;
        }

        #st-progress-bar::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 9px;
            height: 2px;
            background: rgba(0, 0, 0, 0.08);
        }

        #st-progress-fill {
            position: absolute;
            left: 0;
            top: 9px;
            height: 2px;
            width: 0%;
            background: #1a1a1a;
            pointer-events: none;
            transition: width 0.15s linear;
        }

        #st-progress-fill::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #1a1a1a;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.2s;
        }

        #st-progress-bar:hover #st-progress-fill::after { opacity: 1; }

        #st-map-container {
            position: fixed;
            left: 0;
            top: 2px;
            width: 50%;
            bottom: 0;
        }

        #st-map {
            width: 100%;
            height: 100%;
        }

        #day-counter {
            position: absolute;
            left: 12px;
            bottom: 16px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.92);
            color: #1a1a1a;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: 'EB Garamond', Georgia, serif;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
        }

        #story {
            margin-left: 50%;
            width: 50%;
            padding: 40px 48px 60px;
            min-height: 100vh;
        }

        .hero {
            padding: 60px 0 80px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 80px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 1s ease 0.3s forwards;
        }

        .hero h1 {
            font-size: 2.4rem;
            font-weight: 400;
            color: #1a1a1a;
            margin-bottom: 10px;
            line-height: 1.25;
        }

        .hero .about-text {
            color: #444;
            font-size: 1.1rem;
            line-height: 1.9;
            margin-bottom: 12px;
        }

        .hero-summary {
            color: #999;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
            display: flex;
            flex-wrap: wrap;
            gap: 0;
            justify-content: flex-start;
        }

        .hero-summary .stat-item { white-space: nowrap; }
        .hero-summary .stat-sep { margin: 0 6px; }

        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .day-card {
            margin-bottom: 90px;
            scroll-margin-top: 60px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .day-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .day-card .day-photo {
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .day-card .day-label {
            font-size: 0.85rem;
            font-style: italic;
            color: #999;
            margin-bottom: 6px;
        }

        .day-card h3 {
            font-weight: 500;
            color: #1a1a1a;
            font-size: 1.35rem;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .day-card .day-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 0;
            margin-bottom: 24px;
            padding: 16px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .day-card .day-stat {
            text-align: center;
            flex: 1 1 0;
            min-width: 60px;
        }

        .day-card .day-stat-value {
            font-size: 1.15rem;
            font-weight: 600;
            color: #1a1a1a;
            line-height: 1.2;
        }

        .day-card .day-stat-label {
            font-size: 0.75rem;
            color: #999;
            letter-spacing: 0.5px;
        }

        .day-description {
            font-size: 1.05rem;
            line-height: 2;
            color: #333;
            white-space: pre-line;
        }

        .day-divider {
            width: 50px;
            height: 1px;
            background: #ddd;
            margin: 0;
        }

        .story-footer {
            padding: 60px 0;
            border-top: 1px solid #e0e0e0;
            color: #999;
            font-size: 1rem;
            font-style: italic;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .story-footer.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .story-footer h2 {
            font-weight: 400;
            color: #1a1a1a;
            font-size: 1.6rem;
            margin-bottom: 10px;
        }

        /* Shared page radio (Story / Flyover) */
        .nav-radio {
            display: inline-flex;
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
            overflow: hidden;
            backdrop-filter: blur(8px);
            font-family: 'EB Garamond', Georgia, serif;
        }

        .nav-radio-btn {
            display: block;
            padding: 4px 12px;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            font-family: inherit;
        }

        a.nav-radio-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .nav-radio-btn.active { color: #fff; font-weight: 600; background: rgba(255,255,255,0.15); cursor: default; }

        /* Story: centered at bottom */
        #st-nav {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
        }

        #st-nav .nav-radio {
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            #story-view {
                display: flex;
                flex-direction: column;
                height: 100vh;
                height: 100dvh;
                overflow: hidden;
            }

            #st-map-container {
                position: relative;
                top: auto;
                left: auto;
                width: 100%;
                height: 35vh;
                height: 35dvh;
                bottom: auto;
                flex-shrink: 0;
            }

            #st-progress-bar {
                position: relative;
                height: 24px;
                flex-shrink: 0;
                background: transparent;
                border-bottom: 1px solid rgba(0,0,0,0.08);
            }

            #st-progress-bar::before { top: 11px; height: 2px; background: rgba(0,0,0,0.08); }
            #st-progress-fill { top: 11px; height: 2px; }
            #st-progress-fill::after { opacity: 1; width: 12px; height: 12px; right: -6px; }

            #story {
                margin-left: 0;
                margin-top: 0;
                width: 100%;
                padding: 24px 24px 40px;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .hero h1 { font-size: 1.8rem; }

            .hero {
                padding: 30px 0 50px;
                margin-bottom: 50px;
            }

            .day-card { margin-bottom: 60px; }

            #day-counter {
                font-size: 0.78rem;
                padding: 5px 12px;
                bottom: 8px;
                left: 8px;
            }

            #st-nav { bottom: 16px; }
            .nav-radio-btn { padding: 4px 12px; font-size: 0.75rem; }
        }

        /* ────────────────────────────────────
           Flyover view
           ──────────────────────────────────── */
        #flyover-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
        }

        #fo-map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #fo-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 28px;
            z-index: 20;
            cursor: pointer;
            background: transparent;
        }

        #fo-progress-bar::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 12px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            transition: height 0.15s, top 0.15s;
        }

        #fo-progress-bar:hover::before { height: 6px; top: 11px; }

        #fo-progress-fill {
            position: absolute;
            left: 0;
            top: 12px;
            height: 4px;
            width: 0%;
            background: #fff;
            pointer-events: none;
            transition: width 0.1s linear, height 0.15s, top 0.15s;
        }

        #fo-progress-fill::after {
            content: '';
            position: absolute;
            right: -7px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            transition: width 0.15s, height 0.15s, background 0.15s;
        }

        #fo-progress-bar:hover #fo-progress-fill { height: 6px; top: 11px; background: #5A7AFF; }
        #fo-progress-bar:hover #fo-progress-fill::after { background: #5A7AFF; width: 16px; height: 16px; right: -8px; }

        #fo-controls {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(0, 0, 0, 0.65);
            padding: 8px 16px;
            border-radius: 30px;
            backdrop-filter: blur(8px);
        }

        #fo-controls button {
            background: none;
            border: 1.5px solid white;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: 1px;
            font-family: 'EB Garamond', Georgia, serif;
            transition: all 0.2s;
            white-space: nowrap;
        }

        #fo-controls .zoom-btn svg {
            width: 14px;
            height: 14px;
            vertical-align: -2px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
        }

        #fo-controls .divider {
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }

        #fo-controls button:hover { background: rgba(255, 255, 255, 0.15); }
        #fo-controls button.active { background: white; color: #333; }

        #fo-day-info {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 360px;
            z-index: 10;
            font-family: 'EB Garamond', Georgia, serif;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(8px);
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.5s, transform 0.5s;
        }

        #fo-day-info.visible { opacity: 1; transform: translateX(0); }

        #fo-day-info img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        #fo-day-info .info-body { padding: 16px 22px; }

        #fo-day-info .info-day-num {
            font-size: 0.85rem;
            font-style: italic;
            color: #999;
        }

        #fo-day-info h5 {
            font-weight: 500;
            color: #1a1a1a;
            margin: 2px 0 10px;
            font-size: 1.15rem;
        }

        #fo-day-info .info-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        #fo-day-info .info-stat {
            text-align: center;
            padding: 6px 4px;
        }

        #fo-day-info .info-stat-val {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 1.05rem;
        }

        #fo-day-info .info-stat-lbl {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #999;
        }

        #fo-day-info .info-desc {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #555;
            max-height: 160px;
            overflow-y: auto;
            white-space: pre-line;
        }

        #fo-compass {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            width: 48px;
            height: 48px;
            transition: transform 0.15s ease-out;
        }

        #fo-compass svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3));
        }

        #fo-mile-counter {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 1px;
            color: white;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
            transition: all 0.3s;
        }

        #fo-mile-counter.map-mode {
            color: #1a1a1a;
            text-shadow: none;
            background: rgba(255, 255, 255, 0.92);
            padding: 6px 14px;
            border-radius: 4px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
        }

        /* Flyover mobile */
        @media (max-width: 768px) {
            #fo-progress-bar { height: 36px; }
            #fo-progress-bar::before { top: 14px; height: 8px; }
            #fo-progress-fill { top: 14px; height: 8px; }
            #fo-progress-fill::after { width: 22px; height: 22px; right: -11px; }

            #fo-compass {
                width: 36px;
                height: 36px;
                top: 14px;
                left: 12px;
            }

            #fo-day-info {
                top: 10px;
                right: 10px;
                left: 56px;
                width: auto;
                border-radius: 4px;
                transform: none;
                transition: opacity 0.5s;
            }

            #fo-day-info.visible { transform: none; }
            #fo-day-info img { display: none; }
            #fo-day-info .info-body { padding: 8px 12px; }
            #fo-day-info .info-day-num { font-size: 0.7rem; }

            #fo-day-info h5 {
                font-size: 0.9rem;
                margin: 1px 0 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #fo-day-info .info-stats { gap: 2px; margin-bottom: 0; }
            #fo-day-info .info-stat { padding: 2px 2px; }
            #fo-day-info .info-stat-val { font-size: 0.85rem; }
            #fo-day-info .info-stat-lbl { font-size: 0.5rem; }
            #fo-day-info .info-desc { display: none; }

            #fo-controls {
                bottom: 16px;
                left: 12px;
                right: 12px;
                width: auto;
                transform: none;
                padding: 8px 10px;
                gap: 5px;
                flex-wrap: wrap;
                justify-content: center;
                border-radius: 16px;
            }

            #fo-controls button {
                padding: 5px 14px;
                font-size: 0.75rem;
                letter-spacing: 0.5px;
            }

            #fo-controls .divider { height: 14px; }

            #fo-controls .nav-radio .nav-radio-btn {
                padding: 4px 10px;
                font-size: 0.7rem;
            }

            #fo-mile-counter {
                bottom: 100px;
                font-size: 0.75rem;
                letter-spacing: 0.5px;
            }
        }

        @media (max-width: 380px) {
            #fo-day-info h5 { font-size: 0.8rem; }

            #fo-controls button {
                padding: 4px 10px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>

<body>

    <!-- ── Story View ── -->
    <div id="story-view">
        <div id="st-progress-bar"><div id="st-progress-fill"></div></div>

        <div id="st-map-container">
            <div id="st-map"></div>
            <div id="day-counter">Scroll to begin</div>
        </div>

        <div id="story">
            <div class="hero">
                <h1>2,751 Miles North</h1>
                <p class="about-text">Hello! I'm Sam. Some friends and I walked north for a few months in 2021. I was really gunning for a Taco Bell sponsorship but never got one. Luckily it's the journey that counts.</p>
                <p class="about-text">I tracked every step I took on my Garmin GPS watch and have the full route here.</p>
                <div class="hero-summary" id="hero-summary"></div>
            </div>
            <div id="day-cards"></div>
            <div class="story-footer">
                <h2>What a world.</h2>
                <p>Mexico to Canada &middot; 2,751 miles &middot; 442,268 ft of climbing &middot; 6 pairs of shoes</p>
            </div>
        </div>

        <div id="st-nav"><div class="nav-radio"><span class="nav-radio-btn active">Log</span><a class="nav-radio-btn" href="#flyover">Flyover</a></div></div>
    </div>

    <!-- ── Flyover View ── -->
    <div id="flyover-view" style="display:none">
        <div id="fo-progress-bar"><div id="fo-progress-fill"></div></div>
        <div id="fo-map"></div>

        <div id="fo-compass">
            <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                <polygon points="24,6 28,24 24,22 20,24" fill="#fff" opacity="0.95"/>
                <polygon points="24,42 20,24 24,26 28,24" fill="rgba(255,255,255,0.4)"/>
                <text x="24" y="4" text-anchor="middle" font-size="7" font-family="'EB Garamond',Georgia,serif" fill="white" opacity="0.8">N</text>
            </svg>
        </div>

        <div id="fo-day-info">
            <img id="fo-info-photo" src="" onerror="this.style.display='none'">
            <div class="info-body">
                <div id="fo-info-day-num" class="info-day-num"></div>
                <h5 id="fo-info-name"></h5>
                <div class="info-stats">
                    <div class="info-stat">
                        <div class="info-stat-val" id="fo-info-miles"></div>
                        <div class="info-stat-lbl">Miles</div>
                    </div>
                    <div class="info-stat">
                        <div class="info-stat-val" id="fo-info-vert"></div>
                        <div class="info-stat-lbl">Vert</div>
                    </div>
                    <div class="info-stat">
                        <div class="info-stat-val" id="fo-info-pace"></div>
                        <div class="info-stat-lbl">Pace</div>
                    </div>
                </div>
                <div id="fo-info-desc" class="info-desc"></div>
            </div>
        </div>

        <div id="fo-toast" style="display:none;position:absolute;bottom:90px;left:50%;transform:translateX(-50%);z-index:20;background:rgba(0,0,0,0.7);color:rgba(255,255,255,0.85);padding:8px 18px;border-radius:16px;font-size:0.8rem;font-family:'EB Garamond',Georgia,serif;backdrop-filter:blur(8px);opacity:0;transition:opacity 0.5s;pointer-events:none;white-space:nowrap">3D terrain disabled on mobile</div>

        <div id="fo-mile-counter">Mile 0 of 2,751</div>

        <div id="fo-controls">
            <div class="nav-radio"><a class="nav-radio-btn" onclick="location.hash='';return false" href="#">Log</a><span class="nav-radio-btn active">Flyover</span></div>
            <div class="divider"></div>
            <button id="fo-playBtn" onclick="foTogglePlay()">Start</button>
            <div class="divider"></div>
            <button class="speed-btn" onclick="foSetSpeed(0)">.25x</button>
            <button class="speed-btn" onclick="foSetSpeed(1)">.5x</button>
            <button class="speed-btn active" onclick="foSetSpeed(2)">1x</button>
            <button class="speed-btn" onclick="foSetSpeed(3)">2x</button>
            <button class="speed-btn" onclick="foSetSpeed(4)">4x</button>
            <button class="speed-btn" onclick="foSetSpeed(5)">8x</button>
            <div class="divider"></div>
            <button class="view-btn active" onclick="foSetView('3d')">3D</button>
            <button class="view-btn" onclick="foSetView('map')">Map</button>
            <div class="divider"></div>
            <button class="zoom-btn" onclick="foAdjustZoom(-1)"><svg viewBox="0 0 16 16"><circle cx="7" cy="7" r="5"/><line x1="10.5" y1="10.5" x2="14" y2="14"/><line x1="5" y1="7" x2="9" y2="7"/></svg></button>
            <button class="zoom-btn" onclick="foAdjustZoom(1)"><svg viewBox="0 0 16 16"><circle cx="7" cy="7" r="5"/><line x1="10.5" y1="10.5" x2="14" y2="14"/><line x1="5" y1="7" x2="9" y2="7"/><line x1="7" y1="5" x2="7" y2="9"/></svg></button>
            <div class="divider"></div>
            <button id="fo-restartBtn" onclick="foRestart()" style="display:none">Restart</button>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // ══════════════════════════════════════
        // Shared helpers
        // ══════════════════════════════════════
        function formatPace(p) {
            var mins = Math.floor(p);
            var secs = Math.round(60 * (p - mins));
            if (secs === 60) { mins++; secs = 0; }
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        function commas(n) {
            return Math.round(n).toLocaleString();
        }

        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FtcnlhbjE4IiwiYSI6ImNrNmZ4aXBwbDByOG0za3A2YmljN2RqZmoifQ.7uz_HttVRtIdjiq2V4oJKg';

        // Shared data
        var isMobile = window.innerWidth <= 768;
        var totalMiles = coordinates.reduce(function (s, d) { return s + d.distance_miles; }, 0);
        var totalVert = coordinates.reduce(function (s, d) { return s + d.vert_feet; }, 0);
        var totalCals = coordinates.reduce(function (s, d) { return s + d.calories; }, 0);

        var firstDate = new Date(coordinates[0].start_date_local.substring(0, 10));
        var lastDate = new Date(coordinates[coordinates.length - 1].start_date_local.substring(0, 10));
        var totalDays = Math.round((lastDate - firstDate) / (1000 * 60 * 60 * 24)) + 1;

        function dayNumber(d) {
            return Math.round((new Date(d.start_date_local.substring(0, 10)) - firstDate) / (1000 * 60 * 60 * 24)) + 1;
        }

        // ══════════════════════════════════════
        // Story
        // ══════════════════════════════════════
        (function initStory() {
            // Hero summary
            var summaryStats = [
                totalDays + ' days',
                commas(totalMiles) + ' miles',
                commas(totalVert) + ' ft'
            ];
            document.getElementById('hero-summary').innerHTML = summaryStats.map(function (s, i) {
                return (i > 0 ? '<span class="stat-sep">\u00b7</span>' : '') +
                    '<span class="stat-item">' + s + '</span>';
            }).join('');

            // Generate day cards
            var cumulativeMiles = 0;
            var cardsHTML = coordinates.map(function (d, i) {
                cumulativeMiles += d.distance_miles;
                var pace = formatPace(d.pace);
                var dateStr = d.start_date_local.substring(0, 10);
                var dayNum = dayNumber(d);
                return '<div class="day-card" data-day="' + i + '" data-mile="' + cumulativeMiles.toFixed(0) + '" data-daynum="' + dayNum + '">' +
                    '<img class="day-photo" src="' + d.photo_url + '" loading="lazy" onerror="this.onerror=null; this.style.display=\'none\';">' +
                    '<div class="day-label">Day ' + dayNum + ' &middot; ' + dateStr + '</div>' +
                    '<h3>' + d.name.replace(/^Day\s+\d+:\s*/i, '') + '</h3>' +
                    '<div class="day-stats">' +
                        '<div class="day-stat"><div class="day-stat-value">' + d.distance_miles.toFixed(1) + '</div><div class="day-stat-label">miles</div></div>' +
                        '<div class="day-stat"><div class="day-stat-value">' + commas(d.vert_feet) + '</div><div class="day-stat-label">ft elev gain</div></div>' +
                        '<div class="day-stat"><div class="day-stat-value">' + pace + '</div><div class="day-stat-label">per mi</div></div>' +
                        '<div class="day-stat"><div class="day-stat-value">' + d.calories.toFixed(0) + '</div><div class="day-stat-label">cal</div></div>' +
                    '</div>' +
                    '<div class="day-description">' + d.description.replace(/</g, '&lt;') + '</div>' +
                    (i < coordinates.length - 1 ? '<div class="day-divider" style="margin-top:60px;"></div>' : '') +
                '</div>';
            }).join('');
            document.getElementById('day-cards').innerHTML = cardsHTML;

            // Map
            var storyMap = new mapboxgl.Map({
                container: 'st-map',
                style: 'mapbox://styles/mapbox/outdoors-v11',
                center: [-118.5, 36.5],
                zoom: 4,
                pitch: isMobile ? 0 : 30
            });

            var currentDay = -1;

            storyMap.on('load', function () {
                if (!isMobile) {
                    storyMap.addSource('mapbox-dem', {
                        type: 'raster-dem',
                        url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                        tileSize: 512,
                        maxzoom: 14
                    });
                    storyMap.setTerrain({ source: 'mapbox-dem', exaggeration: 1.3 });
                }

                storyMap.addSource('past-routes', {
                    type: 'geojson',
                    data: { type: 'Feature', geometry: { type: 'MultiLineString', coordinates: [] } }
                });
                storyMap.addSource('current-route', {
                    type: 'geojson',
                    data: { type: 'Feature', geometry: { type: 'MultiLineString', coordinates: [] } }
                });
                storyMap.addSource('future-routes', {
                    type: 'geojson',
                    data: { type: 'Feature', geometry: { type: 'MultiLineString', coordinates: [] } }
                });

                storyMap.addLayer({
                    id: 'future-routes', type: 'line', source: 'future-routes',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#ccc', 'line-width': 2, 'line-opacity': 0.25 }
                });
                storyMap.addLayer({
                    id: 'past-routes', type: 'line', source: 'past-routes',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#5A7AFF', 'line-width': 3, 'line-opacity': 0.6 }
                });
                storyMap.addLayer({
                    id: 'current-route-glow', type: 'line', source: 'current-route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#5A7AFF', 'line-width': 14, 'line-opacity': 0.15, 'line-blur': 8 }
                });
                storyMap.addLayer({
                    id: 'current-route', type: 'line', source: 'current-route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#5A7AFF', 'line-width': 6, 'line-opacity': 1 }
                });

                var allCoords = coordinates.map(function (d) { return d.lnglat; });
                storyMap.getSource('future-routes').setData({
                    type: 'Feature', geometry: { type: 'MultiLineString', coordinates: allCoords }
                });

                var obsRoot = isMobile ? document.getElementById('story') : null;
                var observer = new IntersectionObserver(function (entries) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) {
                            var dayIdx = parseInt(entry.target.dataset.day);
                            if (dayIdx !== currentDay) {
                                currentDay = dayIdx;
                                highlightDay(dayIdx);
                            }
                        }
                    });
                }, { threshold: 0.3, root: obsRoot });

                document.querySelectorAll('.day-card').forEach(function (card) { observer.observe(card); });

                var fadeObserver = new IntersectionObserver(function (entries) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) entry.target.classList.add('visible');
                    });
                }, { threshold: 0.1, root: obsRoot });

                document.querySelectorAll('.day-card, .story-footer').forEach(function (el) { fadeObserver.observe(el); });
            });

            function highlightDay(dayIdx) {
                var past = coordinates.slice(0, dayIdx).map(function (d) { return d.lnglat; });
                var curr = [coordinates[dayIdx].lnglat];
                var future = coordinates.slice(dayIdx + 1).map(function (d) { return d.lnglat; });

                storyMap.getSource('past-routes').setData({
                    type: 'Feature', geometry: { type: 'MultiLineString', coordinates: past }
                });
                storyMap.getSource('current-route').setData({
                    type: 'Feature', geometry: { type: 'MultiLineString', coordinates: curr }
                });
                storyMap.getSource('future-routes').setData({
                    type: 'Feature', geometry: { type: 'MultiLineString', coordinates: future }
                });

                var lnglat = coordinates[dayIdx].lnglat;
                var bounds = lnglat.reduce(function (b, p) { return b.extend(p); },
                    new mapboxgl.LngLatBounds(lnglat[0], lnglat[0])
                );
                storyMap.fitBounds(bounds, { padding: 80, duration: 1500, pitch: isMobile ? 0 : 40 });

                var card = document.querySelector('.day-card[data-day="' + dayIdx + '"]');
                var mile = card.dataset.mile;
                var dayNum = card.dataset.daynum;
                document.getElementById('day-counter').textContent =
                    'Day ' + dayNum + ' of ' + totalDays + ' \u00b7 Mile ' + parseInt(mile).toLocaleString() + ' of ' + commas(totalMiles);
            }

            var storyEl = document.getElementById('story');
            var stProgressFill = document.getElementById('st-progress-fill');
            var stProgressBar = document.getElementById('st-progress-bar');
            var scrollTarget = isMobile ? storyEl : window;

            function stGetScrollMax() {
                return isMobile
                    ? storyEl.scrollHeight - storyEl.clientHeight
                    : storyEl.scrollHeight + storyEl.offsetTop - window.innerHeight;
            }

            scrollTarget.addEventListener('scroll', function () {
                if (document.getElementById('story-view').style.display === 'none') return;
                var scrollTop = isMobile ? storyEl.scrollTop : window.scrollY;
                var scrollHeight = stGetScrollMax();
                var progress = scrollHeight > 0 ? Math.min(Math.max(scrollTop / scrollHeight, 0), 1) * 100 : 0;
                stProgressFill.style.width = progress + '%';
            });

            // Click/drag to scroll
            var stScrubbing = false;
            function stScrubTo(e) {
                var rect = stProgressBar.getBoundingClientRect();
                var x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                var fraction = Math.max(0, Math.min(1, x / rect.width));
                var scrollMax = stGetScrollMax();
                var target = fraction * scrollMax;
                if (isMobile) {
                    storyEl.scrollTop = target;
                } else {
                    window.scrollTo(0, target);
                }
            }
            stProgressBar.addEventListener('mousedown', function (e) { stScrubbing = true; stScrubTo(e); });
            stProgressBar.addEventListener('touchstart', function (e) { stScrubbing = true; stScrubTo(e); }, { passive: true });
            document.addEventListener('mousemove', function (e) { if (stScrubbing) stScrubTo(e); });
            document.addEventListener('touchmove', function (e) { if (stScrubbing) stScrubTo(e); }, { passive: true });
            document.addEventListener('mouseup', function () { stScrubbing = false; });
            document.addEventListener('touchend', function () { stScrubbing = false; });
        })();

        // ══════════════════════════════════════
        // Flyover (lazy init)
        // ══════════════════════════════════════
        var foMap = null;
        var foInitialized = false;
        var foIsPaused = true;
        var foCurrentDayIdx = -1;
        var foSpeeds = [0.25, 0.5, 1, 2, 4, 8];
        var foSpeedIdx = 2;
        var foFractionalIdx = 0;
        var foTrailPointCount = 0;
        var foTrailCoords = [];
        var foSmoothLng = 0;
        var foSmoothLat = 0;
        var foSmoothBearing = 0;
        var foFlyoverZoom = 14;
        var foMapViewZoom = 10;
        var foIsMapView = false;
        var foPitch = isMobile ? 30 : 60;
        var foTransitionUntil = 0;
        var foLastFrameTime = 0;
        var foPendingStyleLoad = false;
        var foAnimateFn = null;

        var foRawPoints = [];
        var foAllPoints = [];
        var foDayBoundaries = [];
        var foDayEndPoints = [];
        var foCampsiteCount = 0;
        var foTotalMiles = 0;

        var FO_MS_PER_POINT = 3.3;
        var FO_LOOK_AHEAD = 25;
        var FO_HALF_LIFE = 0.25;
        var FO_BEARING_HALF_LIFE = 1.2;
        var FO_LAMBDA = -Math.log(0.5) / FO_HALF_LIFE;
        var FO_BEARING_LAMBDA = -Math.log(0.5) / FO_BEARING_HALF_LIFE;

        function foSmoothDamp(current, target, lambda, dt) {
            return current + (target - current) * (1 - Math.exp(-lambda * dt));
        }

        function foSmoothPoints(points, windowSize) {
            var result = [];
            for (var i = 0; i < points.length; i++) {
                var sumLng = 0, sumLat = 0, count = 0;
                for (var j = Math.max(0, i - windowSize); j <= Math.min(points.length - 1, i + windowSize); j++) {
                    sumLng += points[j][0];
                    sumLat += points[j][1];
                    count++;
                }
                result.push([sumLng / count, sumLat / count]);
            }
            return result;
        }

        function foCatmullRom(p0, p1, p2, p3, t) {
            var t2 = t * t, t3 = t2 * t;
            return 0.5 * ((2 * p1) + (-p0 + p2) * t + (2 * p0 - 5 * p1 + 4 * p2 - p3) * t2 + (-p0 + 3 * p1 - 3 * p2 + p3) * t3);
        }

        function foComputeBearing(lng1, lat1, lng2, lat2) {
            var toRad = Math.PI / 180, toDeg = 180 / Math.PI;
            var dLng = (lng2 - lng1) * toRad;
            var y = Math.sin(dLng) * Math.cos(lat2 * toRad);
            var x = Math.cos(lat1 * toRad) * Math.sin(lat2 * toRad) - Math.sin(lat1 * toRad) * Math.cos(lat2 * toRad) * Math.cos(dLng);
            return (Math.atan2(y, x) * toDeg + 360) % 360;
        }

        function foCampsiteIcon() {
            var size = 48;
            var cx = size / 2, cy = size / 2;
            var canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            var ctx = canvas.getContext('2d');

            // Drop shadow
            ctx.shadowColor = 'rgba(0,0,0,0.25)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetY = 1;

            // White pin circle
            ctx.beginPath();
            ctx.arc(cx, cy, 11, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
            ctx.shadowColor = 'transparent';

            // Tent body
            ctx.beginPath();
            ctx.moveTo(cx, cy - 7);
            ctx.lineTo(cx + 7, cy + 5);
            ctx.lineTo(cx - 7, cy + 5);
            ctx.closePath();
            ctx.fillStyle = '#5A7AFF';
            ctx.globalAlpha = 0.8;
            ctx.fill();
            ctx.globalAlpha = 1;

            // Tent opening
            ctx.beginPath();
            ctx.moveTo(cx - 2, cy + 5);
            ctx.lineTo(cx, cy + 1);
            ctx.lineTo(cx + 2, cy + 5);
            ctx.fillStyle = '#fff';
            ctx.fill();

            // Flag pole
            ctx.beginPath();
            ctx.moveTo(cx, cy - 7);
            ctx.lineTo(cx, cy - 12);
            ctx.strokeStyle = '#5A7AFF';
            ctx.lineWidth = 1.2;
            ctx.globalAlpha = 0.8;
            ctx.stroke();
            ctx.globalAlpha = 1;

            // Small flag
            ctx.beginPath();
            ctx.moveTo(cx, cy - 12);
            ctx.lineTo(cx + 4, cy - 10.5);
            ctx.lineTo(cx, cy - 9);
            ctx.fillStyle = '#5A7AFF';
            ctx.globalAlpha = 0.7;
            ctx.fill();
            ctx.globalAlpha = 1;

            return { width: size, height: size, data: ctx.getImageData(0, 0, size, size).data };
        }

        function foCampsiteFeatures(upToDayIdx) {
            var features = [];
            for (var i = 0; i < upToDayIdx; i++) {
                features.push({
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: foDayEndPoints[i] }
                });
            }
            return { type: 'FeatureCollection', features: features };
        }

        function foAngleDiff(a, b) {
            var diff = b - a;
            while (diff > 180) diff -= 360;
            while (diff < -180) diff += 360;
            return diff;
        }

        function foTogglePlay() {
            foIsPaused = !foIsPaused;
            document.getElementById('fo-playBtn').textContent = foIsPaused ? 'Start' : 'Pause';
            document.getElementById('fo-playBtn').classList.toggle('active', !foIsPaused);
            if (!foIsPaused && foAnimateFn) requestAnimationFrame(foAnimateFn);
        }

        function foSetSpeed(idx) {
            foSpeedIdx = idx;
            document.querySelectorAll('#fo-controls .speed-btn').forEach(function (btn, i) {
                btn.classList.toggle('active', i === idx);
            });
        }

        function foRestart() {
            foFractionalIdx = 0;
            foTrailPointCount = 0;
            foTrailCoords = [foRawPoints[0]];
            foSmoothLng = foAllPoints[0][0];
            foSmoothLat = foAllPoints[0][1];
            foSmoothBearing = 0;
            foCurrentDayIdx = -1;
            foCampsiteCount = 0;
            foIsPaused = true;
            foLastFrameTime = 0;
            document.getElementById('fo-playBtn').textContent = 'Start';
            document.getElementById('fo-playBtn').classList.remove('active');
            document.getElementById('fo-restartBtn').style.display = 'none';
            document.getElementById('fo-progress-fill').style.width = '0%';
            var campSrc = foMap.getSource('campsites');
            if (campSrc) campSrc.setData({ type: 'FeatureCollection', features: [] });
            var trailSrc = foMap.getSource('trail');
            if (trailSrc) trailSrc.setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: [foRawPoints[0]] } });
            var hikerSrc = foMap.getSource('hiker');
            if (hikerSrc) hikerSrc.setData({ type: 'Feature', geometry: { type: 'Point', coordinates: foAllPoints[0] } });
            foMap.jumpTo({ center: foAllPoints[0], pitch: foPitch, zoom: foFlyoverZoom, bearing: 0 });
            foUpdateDayInfo(0);
            document.getElementById('fo-mile-counter').textContent = 'Mile 0 of ' + commas(foTotalMiles);
            if (foAnimateFn) requestAnimationFrame(foAnimateFn);
        }

        function foSetView(view) {
            var was = foIsMapView;
            foIsMapView = (view === 'map');
            if (foIsMapView === was) return;
            document.querySelectorAll('#fo-controls .view-btn').forEach(function (btn, i) {
                btn.classList.toggle('active', i === (foIsMapView ? 1 : 0));
            });
            document.getElementById('fo-compass').style.display = foIsMapView ? 'none' : '';
            document.getElementById('fo-mile-counter').classList.toggle('map-mode', foIsMapView);
            foTransitionUntil = performance.now() + 1200;
            foPendingStyleLoad = true;
            foMap.setStyle(foIsMapView
                ? 'mapbox://styles/mapbox/outdoors-v11'
                : 'mapbox://styles/mapbox/satellite-streets-v11');
        }

        function foAddTrailLayers() {
            if (!isMobile) {
                if (!foMap.getSource('mapbox-dem')) {
                    foMap.addSource('mapbox-dem', {
                        type: 'raster-dem',
                        url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                        tileSize: 512, maxzoom: 14
                    });
                }
                foMap.setTerrain({ source: 'mapbox-dem', exaggeration: foIsMapView ? 1.2 : 1.5 });
                if (!foIsMapView) {
                    foMap.addLayer({
                        id: 'sky', type: 'sky',
                        paint: { 'sky-type': 'atmosphere', 'sky-atmosphere-sun': [0.0, 90.0], 'sky-atmosphere-sun-intensity': 15 }
                    });
                }
            }

            var idx = Math.floor(foFractionalIdx);
            foTrailCoords = foRawPoints.slice(0, Math.max(1, idx + 1));
            foTrailPointCount = idx + 1;
            foMap.addSource('trail', { type: 'geojson', data: {
                type: 'Feature', geometry: { type: 'LineString', coordinates: foTrailCoords }
            }});

            var trailColor = foIsMapView ? '#5A7AFF' : '#89F';
            foMap.addLayer({ id: 'trail-glow', type: 'line', source: 'trail',
                paint: { 'line-color': trailColor, 'line-width': 12, 'line-opacity': 0.2, 'line-blur': 6 }
            });
            foMap.addLayer({ id: 'trail', type: 'line', source: 'trail',
                paint: { 'line-color': trailColor, 'line-width': foIsMapView ? 3 : 4, 'line-opacity': 0.85 }
            });

            // Campsite markers
            foMap.addImage('campsite', foCampsiteIcon());
            var currentDayIdx = foGetCurrentDay(idx);
            foMap.addSource('campsites', { type: 'geojson', data: foCampsiteFeatures(currentDayIdx) });
            foMap.addLayer({ id: 'campsites', type: 'symbol', source: 'campsites',
                layout: { 'icon-image': 'campsite', 'icon-size': 0.7, 'icon-allow-overlap': true },
                paint: { 'icon-opacity': 0.7 }
            });

            var hikerPt = foAllPoints[Math.min(idx, foAllPoints.length - 1)];
            foMap.addSource('hiker', { type: 'geojson', data: {
                type: 'Feature', geometry: { type: 'Point', coordinates: hikerPt }
            }});
            foMap.addLayer({ id: 'hiker-glow', type: 'circle', source: 'hiker',
                paint: { 'circle-radius': 14, 'circle-color': foIsMapView ? '#5A7AFF' : '#fff', 'circle-opacity': 0.25, 'circle-blur': 0.6 }
            });
            foMap.addLayer({ id: 'hiker', type: 'circle', source: 'hiker',
                paint: { 'circle-radius': 6, 'circle-color': '#fff', 'circle-stroke-color': foIsMapView ? '#5A7AFF' : '#456', 'circle-stroke-width': 2.5 }
            });

            if (foIsMapView) {
                foMap.easeTo({ pitch: 0, bearing: 0, zoom: foMapViewZoom, duration: 800 });
            } else {
                foMap.easeTo({ pitch: foPitch, bearing: foSmoothBearing, zoom: foFlyoverZoom, duration: 800 });
            }
        }

        function foAdjustZoom(delta) {
            if (foIsMapView) {
                foMapViewZoom = Math.max(5, Math.min(18, foMapViewZoom + delta));
            } else {
                foFlyoverZoom = Math.max(10, Math.min(18, foFlyoverZoom + delta));
            }
        }

        function foGetCurrentDay(idx) {
            for (var b = foDayBoundaries.length - 1; b >= 0; b--) {
                if (idx >= foDayBoundaries[b].pointIndex) return b;
            }
            return 0;
        }

        function foUpdateDayInfo(dayIdx) {
            if (dayIdx === foCurrentDayIdx) return;
            foCurrentDayIdx = dayIdx;
            var d = coordinates[dayIdx];
            var panel = document.getElementById('fo-day-info');
            var photo = document.getElementById('fo-info-photo');
            photo.src = d.photo_url;
            photo.style.display = '';
            document.getElementById('fo-info-day-num').textContent = 'Day ' + (dayIdx + 1) + ' of ' + coordinates.length;
            document.getElementById('fo-info-name').textContent = d.name;
            document.getElementById('fo-info-miles').textContent = d.distance_miles.toFixed(1);
            document.getElementById('fo-info-vert').textContent = commas(d.vert_feet) + ' ft';
            document.getElementById('fo-info-pace').textContent = formatPace(d.pace);
            document.getElementById('fo-info-desc').textContent = d.description;
            panel.classList.remove('visible');
            setTimeout(function () { panel.classList.add('visible'); }, 50);
        }

        function initFlyover() {
            if (foInitialized) return;
            foInitialized = true;

            // Build point arrays
            var cumMiles = 0;
            coordinates.forEach(function (d, i) {
                foDayBoundaries.push({ pointIndex: foRawPoints.length, dayIndex: i, cumulativeMiles: cumMiles });
                for (var j = 0; j < d.lnglat.length; j++) {
                    foRawPoints.push(d.lnglat[j]);
                }
                cumMiles += d.distance_miles;
            });
            foTotalMiles = cumMiles;

            // Build day-end campsite points (last GPS coord of each day)
            for (var d = 0; d < coordinates.length; d++) {
                var pts = coordinates[d].lnglat;
                foDayEndPoints.push(pts[pts.length - 1]);
            }

            // Pre-smooth
            foAllPoints = foSmoothPoints(foRawPoints, 50);
            foAllPoints = foSmoothPoints(foAllPoints, 30);

            // Init state
            foTrailCoords = [foRawPoints[0]];
            foSmoothLng = foAllPoints[0][0];
            foSmoothLat = foAllPoints[0][1];

            // Create map
            foMap = new mapboxgl.Map({
                container: 'fo-map',
                style: 'mapbox://styles/mapbox/satellite-streets-v11',
                center: foAllPoints[0],
                zoom: 13,
                pitch: foPitch,
                bearing: 0
            });

            foMap.on('style.load', function () {
                if (foPendingStyleLoad) {
                    foPendingStyleLoad = false;
                    foAddTrailLayers();
                }
            });

            foMap.on('load', function () {
                if (!isMobile) {
                    foMap.addSource('mapbox-dem', {
                        type: 'raster-dem',
                        url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                        tileSize: 512, maxzoom: 14
                    });
                    foMap.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });
                    foMap.addLayer({
                        id: 'sky', type: 'sky',
                        paint: { 'sky-type': 'atmosphere', 'sky-atmosphere-sun': [0.0, 90.0], 'sky-atmosphere-sun-intensity': 15 }
                    });
                }

                foMap.addSource('trail', { type: 'geojson', data: {
                    type: 'Feature', geometry: { type: 'LineString', coordinates: [foRawPoints[0]] }
                }});
                foMap.addLayer({ id: 'trail-glow', type: 'line', source: 'trail',
                    paint: { 'line-color': '#89F', 'line-width': 12, 'line-opacity': 0.2, 'line-blur': 6 }
                });
                foMap.addLayer({ id: 'trail', type: 'line', source: 'trail',
                    paint: { 'line-color': '#89F', 'line-width': 4, 'line-opacity': 0.85 }
                });

                // Campsite markers
                foMap.addImage('campsite', foCampsiteIcon());
                foMap.addSource('campsites', { type: 'geojson', data: {
                    type: 'FeatureCollection', features: []
                }});
                foMap.addLayer({ id: 'campsites', type: 'symbol', source: 'campsites',
                    layout: { 'icon-image': 'campsite', 'icon-size': 0.7, 'icon-allow-overlap': true },
                    paint: { 'icon-opacity': 0.7 }
                });

                foMap.addSource('hiker', { type: 'geojson', data: {
                    type: 'Feature', geometry: { type: 'Point', coordinates: foAllPoints[0] }
                }});
                foMap.addLayer({ id: 'hiker-glow', type: 'circle', source: 'hiker',
                    paint: { 'circle-radius': 14, 'circle-color': '#fff', 'circle-opacity': 0.25, 'circle-blur': 0.6 }
                });
                foMap.addLayer({ id: 'hiker', type: 'circle', source: 'hiker',
                    paint: { 'circle-radius': 6, 'circle-color': '#fff', 'circle-stroke-color': '#456', 'circle-stroke-width': 2.5 }
                });

                foUpdateDayInfo(0);
                requestAnimationFrame(foAnimate);

                // Show mobile toast
                if (isMobile) {
                    var toast = document.getElementById('fo-toast');
                    toast.style.display = '';
                    setTimeout(function () { toast.style.opacity = '1'; }, 100);
                    setTimeout(function () { toast.style.opacity = '0'; }, 2500);
                    setTimeout(function () { toast.style.display = 'none'; }, 3000);
                }
            });

            // Progress bar scrubbing
            var progressBar = document.getElementById('fo-progress-bar');
            var progressFill = document.getElementById('fo-progress-fill');
            var isScrubbing = false;

            function seekTo(fraction) {
                var targetIdx = Math.floor(fraction * (foAllPoints.length - 1));
                foFractionalIdx = targetIdx;
                foSmoothLng = foAllPoints[targetIdx][0];
                foSmoothLat = foAllPoints[targetIdx][1];
                var aheadIdx = Math.min(targetIdx + FO_LOOK_AHEAD, foAllPoints.length - 1);
                foSmoothBearing = foComputeBearing(
                    foAllPoints[targetIdx][0], foAllPoints[targetIdx][1],
                    foAllPoints[aheadIdx][0], foAllPoints[aheadIdx][1]
                );
                foCurrentDayIdx = -1;
                foCampsiteCount = 0;
                progressFill.style.width = (fraction * 100) + '%';

                // Immediately update visuals (even when paused)
                foTrailCoords = foRawPoints.slice(0, targetIdx + 1);
                foTrailPointCount = targetIdx + 1;
                var trailSrc = foMap.getSource('trail');
                var hikerSrc = foMap.getSource('hiker');
                if (trailSrc) trailSrc.setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: foTrailCoords } });
                if (hikerSrc) hikerSrc.setData({ type: 'Feature', geometry: { type: 'Point', coordinates: foTrailCoords[foTrailCoords.length - 1] } });

                var dayIdx = foGetCurrentDay(targetIdx);
                foUpdateDayInfo(dayIdx);
                foCampsiteCount = dayIdx;
                var campSrc = foMap.getSource('campsites');
                if (campSrc) campSrc.setData(foCampsiteFeatures(dayIdx));

                // Update camera
                if (foIsMapView) {
                    foMap.jumpTo({ center: [foSmoothLng, foSmoothLat], pitch: 0, zoom: foMapViewZoom, bearing: 0 });
                } else {
                    foMap.jumpTo({ center: [foSmoothLng, foSmoothLat], pitch: foPitch, zoom: foFlyoverZoom, bearing: foSmoothBearing });
                }

                // Update mile counter
                var dayData = foDayBoundaries[dayIdx];
                var progressInDay = 0;
                if (dayIdx < foDayBoundaries.length - 1) {
                    var dayStart = foDayBoundaries[dayIdx].pointIndex;
                    var dayEnd = foDayBoundaries[dayIdx + 1].pointIndex;
                    progressInDay = (targetIdx - dayStart) / (dayEnd - dayStart);
                }
                var currentMile = dayData.cumulativeMiles + (coordinates[dayIdx].distance_miles * progressInDay);
                document.getElementById('fo-mile-counter').textContent =
                    'Mile ' + commas(currentMile) + ' of ' + commas(foTotalMiles);
            }

            function scrubFromEvent(e) {
                var rect = progressBar.getBoundingClientRect();
                var x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                seekTo(Math.max(0, Math.min(1, x / rect.width)));
            }

            progressBar.addEventListener('mousedown', function (e) { isScrubbing = true; scrubFromEvent(e); });
            progressBar.addEventListener('touchstart', function (e) { isScrubbing = true; scrubFromEvent(e); }, { passive: true });
            document.addEventListener('mousemove', function (e) { if (isScrubbing) scrubFromEvent(e); });
            document.addEventListener('touchmove', function (e) { if (isScrubbing) scrubFromEvent(e); }, { passive: true });
            document.addEventListener('mouseup', function () { isScrubbing = false; });
            document.addEventListener('touchend', function () { isScrubbing = false; });

            function foAnimate(timestamp) {
                if (!foLastFrameTime) foLastFrameTime = timestamp;

                if (foIsPaused || document.getElementById('flyover-view').style.display === 'none') {
                    foLastFrameTime = timestamp;
                    requestAnimationFrame(foAnimate);
                    return;
                }

                var delta = timestamp - foLastFrameTime;
                foLastFrameTime = timestamp;
                var dt = delta / 1000;

                foFractionalIdx += (delta / FO_MS_PER_POINT) * foSpeeds[foSpeedIdx];
                var idx = Math.floor(foFractionalIdx);
                if (idx >= foAllPoints.length - 1) {
                    foIsPaused = true;
                    document.getElementById('fo-playBtn').textContent = 'Done';
                    document.getElementById('fo-restartBtn').style.display = '';
                    return;
                }

                var frac = foFractionalIdx - idx;
                var i0 = Math.max(0, idx - 1), i1 = idx;
                var i2 = Math.min(idx + 1, foAllPoints.length - 1);
                var i3 = Math.min(idx + 2, foAllPoints.length - 1);

                var targetLng = foCatmullRom(foAllPoints[i0][0], foAllPoints[i1][0], foAllPoints[i2][0], foAllPoints[i3][0], frac);
                var targetLat = foCatmullRom(foAllPoints[i0][1], foAllPoints[i1][1], foAllPoints[i2][1], foAllPoints[i3][1], frac);

                foSmoothLng = foSmoothDamp(foSmoothLng, targetLng, FO_LAMBDA, dt);
                foSmoothLat = foSmoothDamp(foSmoothLat, targetLat, FO_LAMBDA, dt);

                var aheadIdx = Math.min(idx + FO_LOOK_AHEAD, foAllPoints.length - 1);
                var targetBearing = foComputeBearing(foAllPoints[idx][0], foAllPoints[idx][1], foAllPoints[aheadIdx][0], foAllPoints[aheadIdx][1]);
                foSmoothBearing += foAngleDiff(foSmoothBearing, targetBearing) * (1 - Math.exp(-FO_BEARING_LAMBDA * dt));
                foSmoothBearing = ((foSmoothBearing % 360) + 360) % 360;

                var trailSrc = foMap.getSource('trail');
                var hikerSrc = foMap.getSource('hiker');
                if (!trailSrc || !hikerSrc) {
                    requestAnimationFrame(foAnimate);
                    return;
                }

                if (foTrailPointCount > idx + 1 || idx - foTrailPointCount > 50) {
                    foTrailCoords = foRawPoints.slice(0, idx + 1);
                    foTrailPointCount = idx + 1;
                } else {
                    while (foTrailPointCount <= idx && foTrailPointCount < foRawPoints.length) {
                        foTrailCoords.push(foRawPoints[foTrailPointCount]);
                        foTrailPointCount++;
                    }
                }
                trailSrc.setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: foTrailCoords } });
                hikerSrc.setData({ type: 'Feature', geometry: { type: 'Point', coordinates: foTrailCoords[foTrailCoords.length - 1] } });

                if (performance.now() >= foTransitionUntil) {
                    if (foIsMapView) {
                        foMap.jumpTo({ center: [foSmoothLng, foSmoothLat], pitch: 0, zoom: foMapViewZoom, bearing: 0 });
                    } else {
                        foMap.jumpTo({ center: [foSmoothLng, foSmoothLat], pitch: foPitch, zoom: foFlyoverZoom, bearing: foSmoothBearing });
                    }
                }

                var dayIdx = foGetCurrentDay(idx);
                foUpdateDayInfo(dayIdx);

                // Update campsite markers when a new day is reached
                if (dayIdx !== foCampsiteCount) {
                    foCampsiteCount = dayIdx;
                    var campSrc = foMap.getSource('campsites');
                    if (campSrc) campSrc.setData(foCampsiteFeatures(dayIdx));
                }

                var dayData = foDayBoundaries[dayIdx];
                var progressInDay = 0;
                if (dayIdx < foDayBoundaries.length - 1) {
                    var dayStart = foDayBoundaries[dayIdx].pointIndex;
                    var dayEnd = foDayBoundaries[dayIdx + 1].pointIndex;
                    progressInDay = (idx - dayStart) / (dayEnd - dayStart);
                }
                var currentMile = dayData.cumulativeMiles + (coordinates[dayIdx].distance_miles * progressInDay);
                document.getElementById('fo-mile-counter').textContent =
                    'Mile ' + commas(currentMile) + ' of ' + commas(foTotalMiles);

                if (!isScrubbing) {
                    progressFill.style.width = (idx / (foAllPoints.length - 1) * 100) + '%';
                }
                if (!foIsMapView) {
                    document.getElementById('fo-compass').style.transform = 'rotate(' + (-foSmoothBearing) + 'deg)';
                }

                requestAnimationFrame(foAnimate);
            }

            foAnimateFn = foAnimate;
        }

        // ══════════════════════════════════════
        // Router
        // ══════════════════════════════════════
        var storyScrollPos = 0;

        function showView(view) {
            var storyView = document.getElementById('story-view');
            var flyoverView = document.getElementById('flyover-view');

            if (view === 'flyover') {
                var stEl = document.getElementById('story');
                storyScrollPos = isMobile ? stEl.scrollTop : window.scrollY;
                storyView.style.display = 'none';
                flyoverView.style.display = '';
                document.body.style.overflow = 'hidden';
                document.title = 'PCT by SLR - Flyover';
                initFlyover();
            } else {
                flyoverView.style.display = 'none';
                storyView.style.display = '';
                document.body.style.overflow = '';
                document.title = 'PCT by SLR';
                foIsPaused = true;
                if (document.getElementById('fo-playBtn')) {
                    document.getElementById('fo-playBtn').textContent = 'Start';
                    document.getElementById('fo-playBtn').classList.remove('active');
                }
                if (isMobile) {
                    var savedPos = storyScrollPos;
                    requestAnimationFrame(function () {
                        document.getElementById('story').scrollTop = savedPos;
                    });
                } else {
                    window.scrollTo(0, storyScrollPos);
                }
            }
        }

        function handleHash() {
            showView(window.location.hash === '#flyover' ? 'flyover' : 'story');
        }

        window.addEventListener('hashchange', handleHash);
        handleHash();

        // Mobile notice (every page load)
        if (isMobile) {
            var note = document.createElement('div');
            note.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(0,0,0,0.75);color:rgba(255,255,255,0.9);padding:10px 20px;border-radius:20px;font-size:0.8rem;font-family:"EB Garamond",Georgia,serif;font-style:italic;backdrop-filter:blur(8px);opacity:0;transition:opacity 0.5s;pointer-events:none;text-align:center;max-width:90vw';
            note.innerHTML = 'Some features like 3D terrain may be limited on mobile.<br>Try a computer browser for the full experience.';
            document.body.appendChild(note);
            setTimeout(function () { note.style.opacity = '1'; }, 200);
            setTimeout(function () { note.style.opacity = '0'; }, 5500);
            setTimeout(function () { note.remove(); }, 6000);
        }
    </script>

</body>

</html>
